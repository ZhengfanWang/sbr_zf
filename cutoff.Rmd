---
title: "Data exclusion based SBR:NMR ratio"
author: "ZW and LA"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Two step approach:
\begin{enumerate}
\item Fit a model to the high quality data to estimate range of true ratios. 
\begin{itemize}
 \item Important: we need some kind of model set-up to capture ``true'' variability across ratios (ie we don't want an overall mean across settings because some settings truly have lower SBRs than others)
 \item Candidate set-up: \\
 For observed ratio $r_i$, assume 
 $$\log(r_i) = \theta_i + \varepsilon_i, $$
with
\begin{itemize}

\item  Random error $\varepsilon_i \sim N(0, v_i)$ with variance $v_i$ calculated as per earlier approach(model details in next part)
\item Random effect $\theta_i$, i.e. $\theta_i \sim N(\mu, \sigma^2)$, where $\sigma^2$ refers to variability across settings
\end{itemize}
\end{itemize}
\item For an observed ratio $r_i$ (from full data base), check if an observed ratio is plausible or not to decide on exclusion.
\begin{itemize}
\item Proposal:  Calculate the probability of observing something more extreme then the observed ratio $r_i$ under the fitted model for log-ratios from step 1:
		\begin{itemize}
			\item Calculate $p_i = \int_{-\infty}^{\log(r_i)} \phi( r) dr$, where $\phi( r)$ is the predictive density for log(ratio) from model in step 1 using observation-specific error variance. Based on candidate model in step 1,  the predictive distribution is given by6:
			$$N(\hat{\mu}, \hat{\delta}^2 +  \hat{\sigma}^2 + v_i), $$ where $\hat{\mu}$ is the point estimate for $\mu$ and $\hat{\delta}^2$ its posterior variance, and $\hat{\sigma}^2$ is the point estimate for the variance of the random effects.       \item Decision rule: if $p_i< x$, exclude observation $i$. We set $x = 0.05$ in calculation below. 
\end{itemize}
\end{itemize}
\end{enumerate}

# Calculation of variance

For an observation $i$, we used a monte carlo approximation to calculate value $v_i$. We assumed

- stillbirths  $\sim$ Bin(total births, observed sbr),
- neonatal deaths $\sim$ Bin(live births, observed nmr)

Generate $S$ random samples form above distributions. For each sample
$$log(ratio_s) = log(\frac{SBR_s}{NMR_s})$$
- Then get $var(log(ratio))$ of S samples $log(ratio_s),s=1,...,S$.

```{r echo=FALSE}
###  SBR:NMR cutoff value study


# load high quality lmin data
hq_data <- openxlsx::read.xlsx("input/High Quality LMIC data_SBR_NMR.xlsx")
full_data <- readRDS("output/sbr.full.rds")
############################# MC method to explore cut off ######################
#-------------------------------#
#     1-step: explore hq data   #
#-------------------------------#

tb <- hq_data$lb + hq_data$sb
sbr <- hq_data$sbr
lb <- hq_data$lb
nmr <- hq_data$nmr

set.seed(123)
```

```{r echo = FALSE, warning = FALSE, message= FALSE}
library(tidyverse)
n <- length(tb)
S <- 1000  #num of MC simulation
log.r_s <- matrix(NA,ncol=S,nrow=n)
for(i in 1:n){
  sb_s <- rbinom(S,tb[i],sbr[i]/1000)
  nm_s <- rbinom(S,lb[i],nmr[i]/1000)
  log.r_s[i,] <- log(sb_s/tb[i]*1/(nm_s/lb[i]))
}
sd_i <- apply(log.r_s,1,sd)

stan.data.cutoff <- list(n = n, y_i = log(sbr/nmr), sd_i = sd_i)
library("rstan")
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
fit <- stan(file= "mod/study_ratio_cutoff.stan",data=stan.data.cutoff,chains = 4,
     control=list(adapt_delta=0.99, max_treedepth=15))

print(fit,pars = c("mu","sigma"))
fit.chain <- extract(fit)
mu <- fit.chain$mu                  # posterior sample of overall mean of log ratio
sigma  <- fit.chain$sigma           # posterior sample of variability across settings.

mu.hat <- mean(mu)
delta.hat.sq <- var(mu)
sigma.hat.sq <- mean(sigma)^2

#----------------------------------------#
#   2-step: Make decision for full set   #
#----------------------------------------#
```
```{r echo = FALSE ,warning = FALSE}
ftb <- full_data$nLB + full_data$nSB
fsbr <- full_data$adj_sbr_unknown
flb <- full_data$nLB
fnmr <- ifelse(is.na(full_data$NMR),full_data$UN_NMR,full_data$NMR)

fn <- length(ftb)
S <- 1000  #num of MC simulation
flog.r_s <- matrix(NA,ncol=S,nrow=fn)
for(i in 1:fn){
  sb_s <- rbinom(S,ftb[i],fsbr[i]/1000)
  nm_s <- rbinom(S,flb[i],fnmr[i]/1000)
  flog.r_s[i,] <- log(sb_s/ftb[i]*1/(nm_s/flb[i]))
}
v_i <- apply(flog.r_s,1,var)

sigma <- sqrt(delta.hat.sq + sigma.hat.sq)
sigma_i <- sqrt(delta.hat.sq + sigma.hat.sq + v_i)
log.ratio_i <- log(ifelse(is.na(full_data$rSN),full_data$rSN_UN,full_data$rSN))
prob_i <- unlist(map2(log.ratio_i,sigma_i,pnorm,mean = mu.hat))
```

Histogram of step 2 $p_i$s is displayed below. About 11.5% observation will be excluded if the cut-off $x$ is set to 5%.

```{r}
hist(prob_i,freq = FALSE, breaks = 20)
round(mean(prob_i<0.05,na.rm = T),digits = 3)
```

Note that cut-off value in terms of observed SBR:NMR ratio depends on the variance of the observations $v_i$. 
The cutoff value is about 0.53 when $v_i = 0$, i.e. for observations with negligible stochastic uncertainty, and decreases as the variance increases. 
```{r}
cutoff_bound <- exp(qnorm(0.05,mu.hat,sigma))
round(cutoff_bound,digits = 2)
```