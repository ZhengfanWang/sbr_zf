---
title: "Cut off based on observed SBR:NMR ratio"
output:
  pdf_document: default
  html_notebook: default
---

```{r, include = FALSE}
library(openxlsx)
library(tidyverse)
lmic_SBR_NMR <- read.xlsx("High Quality LMIC data_SBR_NMR.xlsx")
```


```{r, echo = FALSE}
tb <- lmic_SBR_NMR$lb + lmic_SBR_NMR$sb
sbr <- lmic_SBR_NMR$sbr
lb <- lmic_SBR_NMR$lb
nmr <- lmic_SBR_NMR$nmr
```

## Section 0: uncertainty in the SBR to NMR ratio
For an observation $i$ of the high quality dataset, and for a range of values of probability $P$, we used a monte carlo approximation to calculate value $x_i$ such that Prob(ratio $<$ x_i) = $P$, or in other words, the lower bound of the (1-2P)\% confidence interval associated with the observation. We assumed

- independence between still births and neo deaths
- stillbirths  $\sim$ Bin(total births, observed sbr),
- neonatal deaths $\sim$ Bin(live births, observed nmr)

Samples of the ratios for calculating $x_i$ were obtained as follows: 
```{r}
S <- 1000
n <- length(tb)
ratio_s <- matrix(NA, n, S)
for(i in 1:n){
  sb_s <- rbinom(S, tb[i], sbr[i]/1000)
  nm_s <- rbinom(S, lb[i], nmr[i]/1000)
  ratio_s[i,] <- sb_s/tb[i]*1/(nm_s/lb[i])
}
```

## How shall we use the information from high quality data to set an exclusion criterion for SBR modeling?

We need to finalize an exclusion criterion for observations in the global data set based on their sbr:nmr ratios. In this section, when referring to observations, we are referring to observations in global data set. 

We are working on a 2 step approach: 

- Goal of 1st step: estimate of lowest "plausible" true ratio using high quality data 
  - Problem: All observations are subject to uncertainty, so if we really want info about truth, we should take account of associated uncertainty, so focus on lower bounds of CIs. 
  - However, some obs are very uncertain so lower bounds can get really low...
   - Recent thought: First select observations that are not TOO uncertain, then use min of set of lower bounds. 
   - Ongoing: how to do this, use coeff of variation?
- Goal in 2nd step: exclude obs that are below plausible ratio
  - Take account of unc in the obs, i.e. use upperbound of 90% CI   - see excel file for overview of 90\% upperbounds

## Analysis of plausible lowest ratio based on high quality data

### TO ADD INFO RELATED TO EXCLUSION HERE 

<!-- For each observation $i$ in the high quality data base, and for probabilities $P$ ranging from 1\% to 20\%, we use a monte carlo approximation to calculate value $x_i$ such that Prob(ratio $<$ x_i) = $P$ (or in other words, the lower bound of the (1-2P)\% confidence interval associated with the observation). We assume -->

<!-- - independence between still births and neo deaths -->
<!-- - stillbirths  $\sim$ Bin(total births, observed sbr), -->
<!-- - neonatal deaths $\sim$ Bin(live births, observed nmr) -->

<!-- Samples of the ratios for calculating $x_i$ are obtained as follows:  -->
<!-- ```{r} -->
<!-- S <- 1000 -->
<!-- n <- length(tb) -->
<!-- ratio_s <- matrix(NA, n, S) -->
<!-- for(i in 1:n){ -->
<!--   sb_s <- rbinom(S, tb[i], sbr[i]/1000) -->
<!--   nm_s <- rbinom(S, lb[i], nmr[i]/1000) -->
<!--   ratio_s[i,] <- sb_s/tb[i]*1/(nm_s/lb[i]) -->
<!-- } -->
<!-- ``` -->

We calculated $x_i$ for probabilities $P$ ranging from 1\% to 20\%, or equivalently, we calculated the lower bound $x_i$ of 98\%CIs to 60\% CIs. Histograms of $x_i$ for each $P$ are included at the end of this document. 
Summaries are as follows, where

- one row = one probability $P$, 
- columns are minimum followed by sample percentiles 2.5%, 5%, 10%, 15%, 50%. 

```{r, echo = FALSE}
percentile2 <- apply(ratio_s,1,quantile,na.rm = TRUE,c(0.01,0.025,0.05,0.075,0.1,0.15,0.2))
dim(percentile2)

res <- data.frame(
  min = round(apply(percentile2,1,min,na.rm=TRUE),2),
  t(round(apply(percentile2,1,quantile,c(0.025, 0.05, 0.1, 0.15, 0.5), na.rm=TRUE),2)))
res
```




Histograms:
```{r, echo = FALSE}
histplot <- function(data, breaks = 50, title, xlim, ylim){
  h <- hist(data,plot=FALSE,breaks = breaks)
  h$counts=h$counts/sum(h$counts)
  plot(h,main = title,xlim= xlim, ylim = ylim, ylab = "Relative Frequency",xlab = "SBR:NMR")
}
title <- c("1%","2.5%","5%","7.5%","10%","15%","20%")

#par(mfrow=c(3,3))
for(i in 1:7){
  histplot(percentile2[i,],breaks = 5, title = title[i], xlim = c(0,2),ylim = c(0,0.5))
}
```

