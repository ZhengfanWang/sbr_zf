---
title: "Model comp"
author: "Zhengfan Wang, edits LA to get just loo"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set up
```{r message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

source("0.load_packages.R")
source("1.iso.R")

library("rstan")
library("rstanarm")
library("bayesplot")
library("loo")
```


## IN-SAMPLE

```{r message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

standata <- readRDS(file = "output/stan_data/nhs_nval.rds")     #stan data used for fit model
fit <- readRDS(file = "rdsoutput/reg_hs_nval.rds")       #stan fit for HS model
fit2 <- readRDS(file = "rdsoutput/reg_hscov_nval.rds")  # fit for covariates from HS model
chain <- rstan::extract(fit)
loo1 <- loo(fit, save_psis = TRUE, cores = 4)
chain2 <- rstan::extract(fit2)
loo2 <- loo(fit2, save_psis = TRUE, cores = 4)


y <- standata$Y
yrep <- chain$prep
yrep2 <- chain2$prep
psis1 <- loo1$psis_object
psis2 <- loo2$psis_object
lw <- weights(psis1)
lw2 <- weights(psis2)
color_scheme_set("orange")


#######
#   breaking LOO results down by source type
#----------------------------------------------------

loo_by_source <- function(source,dat,loo){
i <- dat$getj_i == source
y <- dat$Y[i]
yrep <- chain$prep[,i]
psis1 <- loo$psis_object
lw <- weights(psis1)[,i]
color_scheme_set("orange")
ppc_loo_pit_overlay(y, yrep, lw = lw)
}
loo_by_def <- function(def,dat,loo){
  i <- dat$getj_i == def
  y <- dat$Y[i]
  yrep <- chain$prep[,i]
  psis1 <- loo$psis_object
  lw <- weights(psis1)[,i]
  color_scheme_set("orange")
  ppc_loo_pit_overlay(y, yrep, lw = lw)
}

```

The in sample loo validation results of HS and HScov are shown respectively. 

```{r}
# Pareto K diagnostic values for T distribution model
print(loo1)
# Pareto K diagnostic values for normal distribution model
print(loo2)
# overview plot for t distribution model
plot(loo1)
# overview plot for normal distribution model
plot(loo2)

#T distribution model
ppc_loo_pit_overlay(y, yrep, lw = lw)
#normal distribution model
ppc_loo_pit_overlay(y, yrep2, lw = lw2)
```


```{r message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}
countryidx <- standata$getc_i[which(pareto_k_values(loo1) > 0.7)]
countryname <- countryRegionList[countryidx,]$country
year <- standata$gett_i[which(pareto_k_values(loo1) > 0.7)] + 1999
def <- standata$getd_i[which(pareto_k_values(loo1) > 0.7)]
source <- standata$getj_i[which(pareto_k_values(loo1) > 0.7)]
deftype <- c("28wks", "22wks", "24wks", "1000g")
sourcetype <- c("admin", "HMIS", "subnat LR", "survey")
tbadpoint <- data.frame(country = countryname, year = year, definition=deftype[def],source = sourcetype[source])

countryidx2 <- standata$getc_i[which(pareto_k_values(loo2) > 0.7)]
countryname2 <- countryRegionList[countryidx2,]$country
year2 <- standata$gett_i[which(pareto_k_values(loo2) > 0.7)] + 1999
def2 <- standata$getd_i[which(pareto_k_values(loo2) > 0.7)]
source2 <- standata$getj_i[which(pareto_k_values(loo2) > 0.7)]
normalbadpoint <- data.frame(country = countryname2, year = year2, definition=deftype[def2],source = sourcetype[source2])
```
Bad points for HS:

```{r}
print(tbadpoint)
```
Bad points for HScov:

```{r}
print(normalbadpoint)
```



# plot broken down by source type

The following plots come from t distribution and breaking down the points by source type 

```{r}
#T distribution admin, HMIS, subnat LR, survey
loo_by_source(source=1,dat = standata,loo=loo1)
loo_by_source(source=2,dat = standata,loo=loo1)
loo_by_source(source=3,dat = standata,loo=loo1)
loo_by_source(source=4,dat = standata,loo=loo1)
```

The following plots come from normal distribution and breaking down the points by source type 

```{r}
#T distribution admin, HMIS, subnat LR, survey
loo_by_source(source=1,dat = standata,loo=loo2)
loo_by_source(source=2,dat = standata,loo=loo2)
loo_by_source(source=3,dat = standata,loo=loo2)
loo_by_source(source=4,dat = standata,loo=loo2)
```

# plots broken down by definition type

The following plots come from t distribution and breaking down the points by definition type 

```{r}
# 28wks, 22wks, 24wks, 1000g
loo_by_def(def=1,dat = standata,loo=loo1)
loo_by_def(def=2,dat = standata,loo=loo1)
loo_by_def(def=3,dat = standata,loo=loo1)
loo_by_def(def=4,dat = standata,loo=loo1)

```

The following plots come from normal distribution and breaking down the points by definition type 

```{r}
# 28wks, 22wks, 24wks, 1000g
loo_by_def(def=1,dat = standata,loo=loo2)
loo_by_def(def=2,dat = standata,loo=loo2)
loo_by_def(def=3,dat = standata,loo=loo2)
loo_by_def(def=4,dat = standata,loo=loo2)

```

